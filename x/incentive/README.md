# Incentive Module

## Abstract

This document specifies the `x/incentive` module of the Umee chain.

The incentive module allows users to `Bond` collateral `uTokens` from the `x/leverage` module, and governance to create and fund `Incentive Programs` which distribute rewards to users with bonded uTokens over time. Users can `Unbond` tokens over a period of time, after which they can be withdrawn. Unbonding time (and reward amounts) depend on which of the three `Unbonding Tiers` uTokens were bonded to.

The incentive module depends on the `x/leverage` module for information about users' bonded collateral, and also requires that the leverage module prevent bonded or currently unbonding collateral from being withdrawn. There are also a few more advanced interactions, such as instantly unbonding collateral when it is liquidated, and registering an `exponent` when a uToken denom is incentivized for the first time.

## Contents

1. **[Concepts](#concepts)**
   - [Bonding Collateral](#bonding-collateral)
   - [Incentive Programs](#incentive-programs)
   - [Claiming Rewarss](#claiming-rewards)
   - [Reward Accumulators](#reward-accumulators)
   - [Reward Trackers](#reward-trackers)
2. **[State](#state)**
2. **[Messages](#messages)**

## Concepts

### Bonding Collateral

A user can bond their `x/leverage` collaterized `uTokens` in a `x/incentive` module to receive extra rewards.

Bonding prevents the user from using any `leverage.MsgDecollateralize` or `leverage.MsgWithdraw` which would reduce the user's collateral below the bonded amount.

**Example:** a user has `100 u/UMEE` and `50 u/UMEE` collateral in the leverage module. `40 u/UMEE` from that `50 u/UMEE` is bonded in the incentive module. Their maximum `leverage.MsgDecollateralize` allowed by their bond is `10 u/UMEE` and their maximum `leverage.MsgWithdraw` is `110u/UMEE`.

Bonded collateral is eligible for incentive program rewards as long as it is not currently unbonding.

When bonding collateral, the user selects which `Unbonding Tier` it is being bonded to, from `Short/Middle/Long`. When the user start unbonding a uToken, the unbonding tier to which it was originally bonded determines how long the token will be unbonding before it is freed.

Unbonding uTokens are not eligible for incentive rewards while they unbond, but are still subject to the same restrictions on `leverage.MsgWithdraw` and `leverage.MsgDecollateralize` as bonded tokens.

### Incentive Programs

An `IncentiveProgram` is a fixed-duration program which distributes a predetermined total amount of one base token to users which have bonded uTokens of a selected denom during its duration.

For example, the following incentive program would, at each block during the `864000 seconds` after its start at `unix time 1679659746`, distribute a portion of its total `1000 UMEE` rewards to users who have bonded (but are not currently unbonding) `u/uumee` to the incentive module.

```go
ip := IncentiveProgram {
   StartTime: 1679659746, // Mar 24 2023
   Duration: 864000, // 10 days
   UToken: "u/uumee",
   TotalRewards: sdk.Coin{"uumee",1000_000000},
}
```

Reward distribution math is
- **Constant Rate:** Regardless of how much `u/uumee` is bonded to the incentive module at any given block, the program distributes the fraction `blockTime / duration` of its total rewards across users every block it is active (with some corrective rounding).
- **Weighted by Amount:** A user with `200u/uumee` bonded received twice as many rewards on a given block as a user with `100u/uumee` bonded.
- **Weighted by Tier:** A uToken bonded to the short or middle unbonding tier receives fewer rewards than one bonded to the long tier. This exact ratio is determined by the `TierWeightMiddle` and `TierWeightShort` parameters.

When multiple incentive programs are active simultaneously, they compute their rewards independently.

### Claiming Rewards

A user can claim rewards for all of their bonded uTokens at once using `MsgClaim`. When a user claims rewards, an appropriate amount of liquid tokens are sent from the `x/incentive` module account to their wallet.

There are also times where rewards must be claimed automatically to maintain rewards-tracking math. These times are:
- On `MsgBond`
- On `MsgBeginUnbonding`
- When a `leverage.MsgLiquidate` forcefully reduces the user's bonded collateral

Any of the actions above cause the same tokens to be transferred to the user as would have been generated by a `MsgClaim` at the same moment, or a subset of them if only claiming rewards asociated with a single bonded uToken denom or tier.

By automatically claiming rewards whenever a user's bonded amount changes, the module guarantees a mathematically useful invariant:

> Between any two consecutive reward claims by an account associated with a specific bonded uToken denom and tier, the amount of bonded `uTokens` of the given denom to that tier remained constant.

### Reward Accumulators

The incentive module must calculate rewards each block without iterating over accounts and past incentive programs. It does so by storing a number of `RewardAccumulator`

```go
ra := RewardAccumulator{
   denom: "u/uumee",
   exponent: 6,
   tier: 2, // BondTierMiddle
   rewards: "0.00023uumee, 0.00014ibc/1234",
}
```

The example reward accumulator above can be interpreted as:

> If `10^6` `u/uumee` was bonded to tier `2` at genesis and had remained bonded since, it would have accumulated `0.00023uumee` and `0.00014ibc/1234` in rewards.

The incentive module must store 3 `RewardAccumulator` for each bonded uToken denom, since each reward accumulator specifies only a single tier.

During `EndBlock` when rewards are being distributed by incentive programs, the module divides the amount of tokens to distribute by the current `TotalBonded` which it stores for each uToken denom and tier, to increment the `rewards` field in each `RewardAccumulator`.

The `exponent` field is based on the exponent of the base asset associated with the uToken in `denom`. It reduces the loss of precision that may result from dividing the (relatively small) amount of rewards distributed in a single block by the (relatively large) total amount of uTokens bonded.

Note that the `rewards` field must never decrease, nor can any nonzero `RewardAccumulator` be deleted, even after associated incentive programs have ended. The `exponent` field should also never be changed.

### Reward Trackers

`RewardTracker` is stored per-user, and is used in combination with `RewardAccumulator` to calculate rewards since the user's last claim.

```go
rt := RewardTracker{
   account: "umee1s84d29zk3k20xk9f0hvczkax90l9t94g72n6wm",
   denom: "u/uumee",
   tier: 2, // BondTierMiddle
   rewards: "0.00020uumee, 0.00014ibc/1234",
}
```

The example reward tracker above can be interpreted as:

> The last time account `umee1s84d29zk3k20xk9f0hvczkax90l9t94g72n6wm` claimed rewards for `u/uumee` bonded to tier `2`, the value of `RewardAccumulator` (not tracker) for that denom and tier was `"0.00020uumee, 0.00014ibc/1234"`. Therefore, the rewards to claim this time should be based on the _increase_ since then.

Whenever an account claims rewards (including the times when rewards are claimed automatically due to `MsgBond`, `MsgBeginUnbonding`, or `leverage.MsgLiquidate`), the account's `RewardTracker` of the affected denom and tier must be updated to the current value of `RewardAccumulator`.

A `RewardTracker` can also be deleted from the module's store once an account's bonded amount has reached zero for `denom` and `tier`. It will be initialized to the accumulator's current value if the account decides to bond again later.

## State

The incentive module stores the following in its KVStore and genesis state:

- `Params`
- Every upcoming, ongoing, and completed `IncentiveProgram`
- The next available program `ID` (an integer)
- The last unix time rewards were calculated
- `RewardAccumulator` of every bonded uToken denom and tier, unless zero
- `RewardTracker` for each user associated with nonzero bonded uTokens with a nonzero a reward accumulator above
- All nonzero bonded uTokens amounts for each account (excldes unbondings)
- All unbondings in progress for each account

Additionally, some mathematically redundant information is maintained in `KVStore` but not genesis state for efficient operations:
- `TotalBonded` for every bonded uToken denom and tier (total excludes unbondings).
- `TotalUnbonding` for every bonded uToken denom and tier.
- `AmountUnbonding` for each account with one or more unbondings in progress.

These totals are kept in sync with the values they track by the functions in `keeper/store.go`, which update the totals whenever any of the values they reference are changed for any reason (including when importing genesis state).

## Messages

See proto for detailed fields.

Permissionless:
- `MsgClaim` Claims any pending rewards for all bonded uTokens
- `MsgBond` Bonds uToken collateral to a chosen tier (and claims pending rewards for that denom and tier)
- `MsgBeginUnbonding` Starts unbonding uToken collateral from a chosen tier (and claims pending rewards for that denom and tier)
- `MsgSponsor` Funds an entire incentive program with rewards, if it has been passed by governance but not yet funded.

Governance controlled:
- `MsgGovSetParams` Sets module parameters
- `MsgGovCreatePrograms` Creates one or more incentive programs. These programs can be set for community funding or manual funding in the proposal.
